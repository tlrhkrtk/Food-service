<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سفارشی‌ساز غذا</title>

  <style>
    /* ===== پایه‌ای ===== */
    :root {
      --bg: #f0f7ff;
      --card: #ffffff;
      --muted: #666;
      --accent-from: #ff7f50;
      --accent-to: #ffb347;
      --shadow: rgba(0,0,0,0.08);
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: "Tahoma", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 20px;
      color: #333;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== layout ===== */
    .app {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .col {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      flex: 1;
      min-width: 280px;
      box-shadow: 0 8px 24px var(--shadow);
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .col:hover {
      transform: translateY(-4px);
      box-shadow: 0 14px 36px rgba(0,0,0,0.10);
    }

    h3 { margin: 0 0 12px 0; font-size: 1.25rem; color: #333; }
    h4 { margin: 14px 0 8px 0; color: var(--muted); font-size: 1rem; }

    /* ===== canvas (محصول) ===== */
    .base-canvas {
      width: 320px;
      height: 320px;
      margin: 18px auto;
      border-radius: 50%;
      background: #ffe8d6 center/contain no-repeat;
      position: relative;
      box-shadow: inset 0 0 16px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .dropped-item {
      position: absolute;
      width: 48px;
      height: 48px;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: transform .18s ease;
    }
    .dropped-item:hover { transform: translate(-50%, -50%) scale(1.12); }

    /* ===== toppings list ===== */
    .toppings-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .topping-card {
      padding: 10px;
      text-align: center;
      border-radius: 12px;
      cursor: grab;
      background: linear-gradient(135deg,#fff6f3,#fffef9);
      border: 1px solid rgba(0,0,0,0.03);
      box-shadow: 4px 6px 18px rgba(0,0,0,0.04);
      transition: transform .14s ease, box-shadow .14s ease;
      user-select: none;
    }
    .topping-card:hover {
      transform: translateY(-4px);
      box-shadow: 6px 10px 24px rgba(0,0,0,0.06);
    }
    .topping-card img { width: 48px; height: 48px; object-fit: contain; margin-bottom: 6px; }

    /* ===== buttons ===== */
    .btn {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .btn:active { transform: translateY(1px); }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent-from), var(--accent-to));
      color: #fff;
    }
    .btn.ghost {
      background: #f5f7fb;
      color: #444;
    }

    /* ===== qty controls ===== */
    #qtyControls {
      margin-top: 12px;
      display: none;
      justify-content: center;
    }
    #qtyControls .qty-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #qtyValue {
      width: 56px;
      text-align: center;
      border-radius: 10px;
      border: 1px solid #e6e8ee;
      padding: 6px;
      font-weight: 600;
      background: #fff;
    }

    /* ===== product list buttons ===== */
    #productList button {
      width: 100%;
      margin-bottom: 8px;
      text-align: center;
      background: linear-gradient(135deg,#a1c4fd,#c2e9fb);
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      padding: 10px;
      border: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
    }

    /* ===== order summary ===== */
    #orderSummary {
      margin-top: 8px;
      line-height: 1.6;
      color: #333;
    }

    /* ===== status / toast ===== */
    #statusBanner {
      text-align:center;
      padding: 12px;
      background:#fffae6;
      border:1px solid #ffd700;
      border-radius:12px;
      margin-bottom:20px;
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight:600;
      z-index: 9999;
      display: none;
    }

    /* responsive */
    @media (max-width: 980px) {
      .base-canvas { width: 260px; height:260px; }
      .col { min-width: 240px; }
    }
  </style>
</head>
<body>

  <div id="statusBanner">در حال بارگذاری...</div>

  <div id="app" class="app" style="display:none;">

    <!-- مخلفات -->
    <aside class="col left" aria-label="مخلفات">
      <h3>مخلفات</h3>
      <div id="toppingsContainer" class="toppings-list" aria-live="polite"></div>
    </aside>

    <!-- کانواس و کنترل‌ها -->
    <main class="col middle" role="main" aria-labelledby="productTitle">
      <h3 id="productTitle">یک محصول انتخاب کنید</h3>
      <div id="productSubtitle" class="muted" style="color:var(--muted);margin-top:6px"></div>

      <label for="sizeSelect" style="display:block;margin-top:12px;color:var(--muted)">انتخاب سایز:</label>
      <select id="sizeSelect" disabled style="margin-top:6px;padding:8px 12px;border-radius:10px;border:1px solid #e6e8ee"></select>

      <div id="baseCanvas" class="base-canvas" aria-hidden="true"></div>

      <div id="qtyControls">
        <div class="qty-wrap">
          <button id="qtyMinus" class="btn ghost" aria-label="کم کردن تعداد">-</button>
          <input id="qtyValue" value="1" inputmode="numeric" aria-label="تعداد" />
          <button id="qtyPlus" class="btn ghost" aria-label="افزایش تعداد">+</button>
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
        <button id="clearBtn" class="btn ghost" disabled>پاک کردن</button>
        <button id="addToCartBtn" class="btn primary" disabled>افزودن به سبد خرید</button>
      </div>
    </main>

    <!-- لیست محصولات و خلاصه -->
    <aside class="col right" aria-label="محصولات و خلاصه">
      <h3>لیست محصولات</h3>
      <div id="productList" aria-live="polite"></div>

      <h3 style="margin-top:18px">خلاصه</h3>
      <div id="orderSummary" aria-live="polite"></div>
    </aside>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">محصول به سبد اضافه شد</div>

  <script>
    /**
     * نسخهٔ خوانا و مرتب:
     * - اضافه کردن به سبد بدون ریدایرکت
     * - به‌روزرسانی badge (اگر المنتی با data-cart-badge وجود داشته باشد)
     * - ذخیره در localStorage با کلید __pd_cart_v2__
     *
     * جایگزین مسیر JSON، CART_PAGE و سایر مقادیر در صورت نیاز.
     */

    const JSON_PATH = "../data.json";
    const PLACEHOLDER = "https://via.placeholder.com/80";
    const LS_KEY = "__pd_cart_v2__";

    // رفتار پس از افزودن: false => هدایت نشود
    const AUTO_REDIRECT_ON_ADD = false;
    const CART_PAGE = "/pages/cart.html";

    // وضع داخلی
    let MENU = null;
    let currentProduct = null;
    let dropped = [];
    let sizeIndex = 0;
    let currentGroupId = null;

    // Helpers
    function fmtCurrency(n) {
      try { return Number(n).toLocaleString() + " تومان"; }
      catch { return n + " تومان"; }
    }

    function showToast(text = "محصول به سبد اضافه شد", timeout = 1200) {
      const t = document.getElementById("toast");
      t.textContent = text;
      t.style.display = "block";
      clearTimeout(t._to);
      t._to = setTimeout(() => { t.style.display = "none"; }, timeout);
    }

    // LocalStorage cart helpers
    function readMainCart() {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      } catch {
        return [];
      }
    }

    function writeMainCart(arr) {
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(arr || []));
      } catch (e) {
        console.warn("writeMainCart error:", e);
      }

      // update badges if present
      document.querySelectorAll("[data-cart-badge]").forEach(el => {
        const sum = (arr || []).reduce((s, i) => s + (Number(i.qty) || 0), 0);
        el.textContent = sum;
      });
    }

    // Load menu JSON
    async function loadMenu() {
      try {
        const res = await fetch(JSON_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        document.getElementById("statusBanner").style.display = "none";
        return data;
      } catch (err) {
        document.getElementById("statusBanner").textContent = "بارگذاری JSON شکست خورد: " + err.message;
        return null;
      }
    }

    // Render product list
    function renderProductList() {
      const container = document.getElementById("productList");
      container.innerHTML = "";

      (MENU.product_groups || []).forEach(group => {
        const gTitle = document.createElement("h4");
        gTitle.textContent = group.group_title;
        container.appendChild(gTitle);

        (group.group_products || []).forEach(p => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = p.product_name;
          btn.onclick = () => selectProduct(p, group.group_id);
          container.appendChild(btn);
        });
      });
    }

    // When user selects a product
    function selectProduct(p, groupId) {
      currentProduct = p;
      currentGroupId = groupId;
      dropped = [];
      sizeIndex = 0;

      document.getElementById("productTitle").textContent = p.product_name;
      document.getElementById("productSubtitle").textContent =
        "مواد پایه: " + (p.product_content || []).join("، ");

      const sizeSel = document.getElementById("sizeSelect");
      sizeSel.innerHTML = "";
      (p.product_type || []).forEach((t, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        const price = p.product_price && p.product_price[i] ? p.product_price[i] : 0;
        opt.textContent = `${t} — ${fmtCurrency(price)}`;
        sizeSel.appendChild(opt);
      });

      sizeSel.disabled = !(p.product_type && p.product_type.length);
      sizeSel.onchange = () => {
        sizeIndex = parseInt(sizeSel.value || "0", 10);
        refreshSummary();
      };

      document.getElementById("baseCanvas").style.backgroundImage = `url(${p.base_image || PLACEHOLDER})`;

      document.getElementById("clearBtn").disabled = false;
      document.getElementById("addToCartBtn").disabled = false;

      // show qty controls
      document.getElementById("qtyControls").style.display = "flex";
      document.getElementById("qtyValue").value = 1;

      renderToppingsForProduct(p);
      renderDropped();
      refreshSummary();
    }

    // Render toppings for selected product
    function renderToppingsForProduct(p) {
      const container = document.getElementById("toppingsContainer");
      container.innerHTML = "";

      (p.available_toppings || []).forEach(name => {
        const topping = (MENU.toppings || []).find(t => t.name === name);
        if (!topping) return;

        const card = document.createElement("div");
        card.className = "topping-card";
        card.draggable = true;
        card.dataset.name = name;
        card.innerHTML = `
          <img src="${topping.image || PLACEHOLDER}" alt="${name}">
          <div style="font-weight:600">${name}</div>
          <div style="color:var(--muted);margin-top:6px">${fmtCurrency(topping.price)}</div>
        `;

        // درگ
        card.ondragstart = e => e.dataTransfer.setData("text/plain", name);

        // کلیک
        card.onclick = () => addToppingAt(name, 150, 150);

        container.appendChild(card);
      });

      const canvas = document.getElementById("baseCanvas");
      canvas.ondragover = e => e.preventDefault();
      canvas.ondrop = e => {
        e.preventDefault();
        const name = e.dataTransfer.getData("text/plain");
        const rect = canvas.getBoundingClientRect();
        addToppingAt(name, e.clientX - rect.left, e.clientY - rect.top);
      };
    }




    // اضافه کردن مخلف روی خمیر
    function addToppingAt(name, x, y) {
      // جلوگیری از اضافه کردن دوباره
      if (dropped.find(d => d.name === name)) return;

      const rect = document.getElementById("baseCanvas").getBoundingClientRect();
      dropped.push({
        name,
        x: (x / rect.width) * 100,
        y: (y / rect.height) * 100
      });

      renderDropped();
      refreshSummary();

      const card = document.querySelector(`.topping-card[data-name="${name}"]`);
      if (card) {
        card.style.pointerEvents = "none"; 
        card.style.opacity = "0.5";        
        card.draggable = false;            
      }
    }

    // Render objects on canvas without draggability or hover
    function renderDropped() {
      const canvas = document.getElementById("baseCanvas");
      canvas.innerHTML = "";

      dropped.forEach(d => {
        const t = (MENU.toppings || []).find(tt => tt.name === d.name);
        const img = document.createElement("img");
        img.src = t ? t.image : PLACEHOLDER;
        img.className = "dropped-item";
        img.style.left = d.x + "%";
        img.style.top = d.y + "%";
        img.style.transition = "none";     // حذف transition
        img.style.transform = "translate(-50%, -50%)";
        img.style.pointerEvents = "none";  // غیرقابل کلیک

        canvas.appendChild(img);
      });
    }

    // Calculate total price for one unit (base + toppings - discount)
    function calculateTotalPrice() {
      if (!currentProduct) return 0;
      const base = Number(currentProduct.product_price ? (currentProduct.product_price[sizeIndex] || 0) : 0) || 0;

      let toppingsCost = 0;
      dropped.forEach(d => {
        const t = (MENU.toppings || []).find(tt => tt.name === d.name);
        if (t) toppingsCost += Number(t.price || 0);
      });

      let discount = 0;
      if (MENU.Discounts) {
        const disc = (MENU.Discounts || []).find(d => Number(d.group_id) === Number(currentGroupId));
        if (disc) discount = Number(disc.discount || 0);
      }

      const total = base + toppingsCost;
      return Math.round(total - (total * discount / 100));
    }

    // Refresh order summary (one-unit summary)
    function refreshSummary() {
      const os = document.getElementById("orderSummary");
      if (!currentProduct) {
        os.textContent = "هیچ محصولی انتخاب نشده";
        return;
      }

      const base = Number(currentProduct.product_price ? (currentProduct.product_price[sizeIndex] || 0) : 0) || 0;
      let toppingsCost = 0;
      let energy = Number(currentProduct.product_energy || 0);

      dropped.forEach(d => {
        const t = (MENU.toppings || []).find(tt => tt.name === d.name);
        if (t) { toppingsCost += Number(t.price || 0); energy += Number(t.energy || 0); }
      });

      let discount = 0;
      if (MENU.Discounts) {
        const disc = (MENU.Discounts || []).find(d => Number(d.group_id) === Number(currentGroupId));
        if (disc) discount = Number(disc.discount || 0);
      }

      const total = base + toppingsCost;
      const finalPrice = Math.round(total - (total * discount / 100));

      os.innerHTML = `
        <div>قیمت پایه: ${fmtCurrency(base)}</div>
        <div>تعداد مخلفات: ${dropped.length}</div>
        <div>هزینه مخلفات: ${fmtCurrency(toppingsCost)}</div>
        <div>تخفیف گروه: ${discount}%</div>
        <div><strong>جمع کل (برای یک واحد): ${fmtCurrency(finalPrice)}</strong></div>
        <div>انرژی کل: ${energy} kcal</div>
      `;
    }

    // qty controls
    document.addEventListener("DOMContentLoaded", () => {
      const qtyEl = document.getElementById("qtyValue");
      document.getElementById("qtyPlus").addEventListener("click", () => {
        qtyEl.value = Math.max(1, Number(qtyEl.value || 1) + 1);
      });
      document.getElementById("qtyMinus").addEventListener("click", () => {
        qtyEl.value = Math.max(1, Number(qtyEl.value || 1) - 1);
      });
      qtyEl.addEventListener("input", () => {
        let v = parseInt(qtyEl.value.replace(/[^\d]/g, "") || "1", 10);
        if (isNaN(v) || v < 1) v = 1;
        qtyEl.value = v;
      });
    });

    // Add current product to main cart (no redirect by default)
    function addCurrentToMainCart(redirectToCart = false) {
      if (!currentProduct) return;

      const qtyEl = document.getElementById("qtyValue");
      const qty = Math.max(1, parseInt(qtyEl.value || "1", 10));

      const priceNumber = calculateTotalPrice();
      const priceText = fmtCurrency(priceNumber);

      const item = {
        group_id: currentGroupId || null,
        product_id: currentProduct.product_id || currentProduct.id || 0,
        product_name: currentProduct.product_name || currentProduct.name || "محصول",
        price_text: priceText,
        price_number: Number(priceNumber) || 0, // price per unit
        qty: qty,
        image: currentProduct.base_image || (currentProduct.product_image && currentProduct.product_image[0]) || "",
        size_label: currentProduct.product_type ? (currentProduct.product_type[sizeIndex] || "") : "",
        toppings: dropped.map(d => d.name || d)
      };

      // If an app-level CART object exists use it
      const CART = window.__PD_CART_V2;
      if (CART && typeof CART.addToCart === "function") {
        try {
          CART.addToCart(item);
          if (typeof CART.showToast === "function") CART.showToast("محصول به سبد اضافه شد");
          showToast("محصول به سبد اضافه شد");
        } catch (err) {
          console.warn("CART.addToCart failed:", err);
        }
      } else {
        // fallback: store in localStorage and merge similar items
        const arr = readMainCart();

        // merge items with same product_id + size_label + toppings (sorted)
        const keyMatch = it => {
          try {
            const a = (it.toppings || []).slice().sort().join("|");
            const b = (item.toppings || []).slice().sort().join("|");
            return Number(it.product_id) === Number(item.product_id) &&
                   String(it.size_label) === String(item.size_label) &&
                   a === b;
          } catch {
            return false;
          }
        };

        const found = arr.find(keyMatch);
        if (found) {
          found.qty = Number(found.qty || 0) + Number(item.qty || 0);
        } else {
          arr.push(item);
        }

        writeMainCart(arr);
        showToast("محصول به سبد اضافه شد");
      }

      // do not redirect unless requested
      if (redirectToCart) {
        setTimeout(() => { window.location.href = CART_PAGE; }, 350);
      }
    }

    // Initialization
    document.addEventListener("DOMContentLoaded", async () => {
      MENU = await loadMenu();
      if (!MENU) return;

      document.getElementById("app").style.display = "flex";
      renderProductList();
      refreshSummary();

      document.getElementById("clearBtn").addEventListener("click", () => {
        dropped = [];
        renderDropped();
        refreshSummary();
      });

      document.getElementById("addToCartBtn").addEventListener("click", (e) => {
        e.preventDefault();
        addCurrentToMainCart(AUTO_REDIRECT_ON_ADD);
      });
    });
  </script>
</body>
</html>
